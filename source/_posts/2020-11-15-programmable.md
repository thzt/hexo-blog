---
layout: post
categories: Software
title: 可编程的基础设施

---

这些年，软件工程师的数量激增猛涨，越来越多的人，具备了**用代码解决问题**的能力了。这样的发展趋势，对软件行业本身也产生了一定的影响。下面我来列举三个例子：

<br/>

其一，[Racket](http://homes.sice.indiana.edu/samth/new-web/) 支持 “面向语言进行编程”（[LOP](https://cs.brown.edu/~sk/Publications/Papers/Published/fffkbmt-programmable-prog-lang/paper.pdf)），是一门 “可编程” 的编程语言。旨在解决使用特定语言编程的时候，[eDSL](https://wiki.c2.com/?EmbeddedDomainSpecificLanguage) 难集成的问题。语言，本来就是编程用的，语言本身也变成了**可编程**的，这是一件有趣的事情。

<br/>

其二，[Roslyn](https://medium.com/microsoft-open-source-stories/how-microsoft-rewrote-its-c-compiler-in-c-and-made-it-open-source-4ebed5646f98) 不再是一个编译工具了，而是一个 “编译平台”（[Compiler Platform](https://github.com/dotnet/roslyn)）。因为它共享了编译器内部的工作机制，让世界**以编程的方式消费**。编译器，不再作为单独的一个工具提供服务了，而是变得更加**开放**了。

<br/>

其三，“基础设施即代码”（[IaC](https://en.wikipedia.org/wiki/Infrastructure_as_code)），它本来是随着 2006 年第二代 web 框架的潮流而出现的，当时人们正在考虑底层的计算资源，能否以[按需计费](https://en.wikipedia.org/wiki/Utility_computing)的方式提供服务。基础设施，不再使用人工配置的方式提供支持了，而是使用高级的编程语言进行[控制](https://book.douban.com/subject/26589406/)。

<br/>

这三个例子，共同反映了一种新的**潮流**，现有软件行业内部的一些概念，正在朝着**更加有利于编程**的方式在发展了。这是全民编程能力提高之后，必然会发生的事情。下文我们就讨论一下，现阶段或者未来，我们应该如何转换想法，向一线团队提供 “可编程的基础设施”。

### 指导思想

每一种理念，其实都包含了自身的指导思想，也即是说，想法、思路和实践，到底是怎样得出来的。要想向开发者提供服务，让基础设施变得可编程，结合不同的情况，肯定会有不同的取舍和折中，但**指导思想是不变的**。

<br/>

总结下来，贯穿本文的指导思想会有四点：

+ 依赖可追踪

+ 数据导向

+ 平权性

+ 接口优先于界面

下文不论是从系统架构的角度，还是产品、工程和设计的角度，都能看到这四点指导思想的影子。

### 软件架构

首先，软件架构是与组织架构密不可分的，这也是 [康威定律](https://zh.wikipedia.org/zh-sg/%E5%BA%B7%E5%A8%81%E5%AE%9A%E5%BE%8B) 所指示的，

> 设计系统的架构受制于产生这些设计的组织的沟通结构。

<br/>

不同形式的组织架构，就会衍生出不同的软件架构。因为合理架构的目的，也是为了降低研发成本，用最恰当的方式尽可能多满足[多方利益](https://book.douban.com/subject/24530471/)。《[Clean Architecture](https://book.douban.com/subject/30333919/)》中有一句话，我觉得说的非常好，

> Software architecture is the art of drawing lines that I call boundaries.

> Those boundaries separate software elements from one another, and restrict those on one side from knowing about those on the other.

<br/>

即，架构学问的艺术性体现在**划分边界**。好的边界划分策略，可以让边界两侧尽量不必了解对方，也能一起工作。从这一点上来看，将提供基础服务的团队，与一线开发团队，进行划分，不仅是组织架构上的一种划分，体现在软件层面，也是对软件架构中**系统边界**的一种划分。基础设施团队，应当尽可能少的暴露接口，并且这些接口都应当是可追踪的。

<br/>

何为 “可追踪” 的呢？指的是，需要明确的知道，这些接口正在被谁使用。只有暴露出的了可追踪的接口，接口的健康度，中后期的升级换代，才有据可依，否则所建立的任何依赖都是**脆弱的**，每一次接口变更的影响范围都是不确定的。

### 数据导向

重视数据，是近几年才开始流行的趋势，在以前，人们的关键决策，更多的是依靠行业经验和敏锐的直觉所做出来的，这是一件**风险**很大的事情。

<br/>

数据导向的研发方式，并不是仅仅软件行业这么做，它其实起源于人们多年来在自然科学领域，所总结出来的经验教训。即，任何假说必须有**实验数据**进行支撑，否则就无法证实。人们将自然科学中的这一套方法论，统称为 [科学方法](https://zh.wikipedia.org/zh/%E7%A7%91%E5%AD%A6%E6%96%B9%E6%B3%95)，它是一种系统性的寻求知识的过程，涉及了以下三个步骤：

+ 问题的认知与表述

+ 实验数据的收集

+ 假说的构成与测试

数据导向的研发方式，正是科学方法的忠实表现。回到文中的话题，基础设施团队的数据，应当一开始就建立起来。这些数据源于一线团队的各类**研发活动**。只有拿到这些数据，基础设施优化才会变得**有据可依有理可循**。所以问题就转换成了，如何采用一种无侵入的集中式的方式，收集一线开发团队的研发活动数据呢？

<br/>

“无侵入” 代表了**横向扩展性**，不需要一线开发团队更改任何代码，零成本接入新团队。“集中式” 代表了收集方式是**聚敛的**，不会散布到各处。也就是说，尽可能让外部依赖变得**确定**和**唯一**。

### 平台属性

关于什么是 “平台” 的说法，不同人会有不同的理解，目前也没有一个准确的定义。但是比较常见的说法是，平台提供了 “大家一起玩” 的舞台。在平台上 “玩” 的人们，将**一视同仁**。

<br/>

基础设施团队，**未必需要**将软件系统做成平台。只需要向一线开发者提供所需的服务就行了。但是做成平台，会有这些好处，

+ 服务提供的方式变成了可扩展的，有利于促进沟通，打造一个研发生态闭环

+ 平台更有利于内省，打破了需求方和实现方的单向关系

+ 降低了平台的研发成本，平台的内核可以做的更小

此外，软件平台这种产品形态，通常会与特定的称为 “微服务” 的技术架构相对应，思想是共通的 —— 想办法**让用户也可以帮助平台**提供功能。这与文本篇首提及的三个例子，有异曲同工之妙。软件服务最终会朝着更加开放的方式发展。

<br/>

这就是所谓 “平权性” 最原始动机，“平权” 并不是指平台用户与平台的开发者，有相同的权限，而只是说，应该让平台用户，也有帮助平台发展的机会。

### 命令行接口

编程设计领域，流传着一些 “警句”，称为《[Epigrams in Programming](https://cpsc.yale.edu/epigrams-programming)》。其中，有一句是这样说的，

> A good system can’t have a weak command language.

一个优秀的系统，不能没有**命令行接口**。

<br/>

命令行接口是**面向程序**的，而常见的图形界面是面向人类的。一个系统如果只提供图形界面，那么就难以用程序的方式跟它进行交互，这会使得它自己变得**封闭**，无法纳入到一个更大的**软件生态圈**中。

<br/>

其实，人们能总结出这一警句，并不是空穴来风，《[Linux/Unix设计思想](https://book.douban.com/subject/7564417/)》也印证了这个说法，

> 良好的程序员编写优秀代码，优秀的程序员借用优秀代码

<br/>

能将其他软件模块、程序或配置文件，集成到自己的应用程序中，会成倍的**放大**前辈程序员们的工作成果，这就是软件的 “**杠杆效应**”。命令行接口，使得系统可以被当做软件杠杆来使用。

<br/>

乔布斯在 “遗失的访谈” 中提到过，

> 生活中多数东西，最好与普通之间的差距不超过两倍，好比说纽约的出租车司机，最棒的司机与普通司机之间的差距大概是30%，最好的与普通之间的差距有多大呢？20%？最好的CD机与普通CD机的差距有多大？20%？

> 这种差距很少超过两倍。但是在软件行业，还有硬件行业，这种差距有可能超过15倍，甚至100倍，这种现象很罕见。

善用软件杠杆，可以产出 15 倍，甚至 100 倍的工作成果。

### 结语

本文总结了自己对 “可编程的基础设施” 的一些理解，以及如何打造一支高效稳定的基础设施团队。当然还有太多的细节，无法全部展开来讨论了，并且具体的实践方案，也要结合特定的情形进行考量。

<br/>

不过总而言之，基础设施的研发方式，与一线直接面向最终用户的研发方式，都会有很大的不同。**这是不同领域在 “业务” 层面上的本质区别。**

<br/>

单纯的提高效率降低成本，可能并不全是一个完善的基础设施团队的唯一关注点，如何与一线团队站在一起，保证整体业务的稳定性，才是最重要的，赢得了战争，才有后续发展的可能性。
