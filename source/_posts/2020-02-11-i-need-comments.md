---
layout: post
categories: Mind
title: 我的代码需要注释

---

在众多类型的软件项目中，有一种 “脏活累活”，

那就是，把老系统下线，用新系统替代它。

<br/>

这项工作，我们常称之为 “功能迁移”。

用另外一套代码，实现既有系统的**所有**功能。

<br/>

这看似不是很难，

毕竟旧系统提供了哪些功能，不都在代码中吗？抄过来就行了。

其实不然。

<br/>

因为大部分系统都没有一个详细的规格说明，

用户也可能正以各种 “意想不到” 的方式依赖着它，

还原系统的**所有外部效用**，需要兼容很多这样的场景，非常容易出错。

<br/>

在进行 “功能迁移” 的时候，我们最担心的是那些缺少注释的代码，

最常见的问题是，不明白代码的原作者**当初为什么要这样写**。

“功能迁移” 简直是程序员的噩梦。

<br/>

是什么原因导致代码中的注释这么少呢？

我想很大一种可能是，人们**理解错了** “代码即文档” 的**本意**。

<br/>

所谓 “代码即文档”，指的是，

优秀的代码不需要注释，它自己就能解释清楚。

<br/>

这句话说的有理，能做到这样，确实算得上优秀。

可是，不写注释的，未必是优秀的代码，更有可能是 “晦涩难懂”。

### 正视自己的水平

Apache 基金会副总裁 Niclas Hedhman 在 2016 中国开源年会上，

曾做做过一次演讲，主题是 《[屋中的大象](https://www.oschina.net/news/79166/apache-foundation-ceo-decades-views)》。

其中提到了优秀程序员的占比问题。

<br/>

> 60% 的程序员，认为自己是天才的或良好的程序员，

> 只有 30% 左右的人，认为自己是一般的程序员。

> 而实际上，天才程序员只有不到 1%，大量的程序员属于一般、较差的程序员。

<br/>

所以在写代码的时候，我们应该先**正视自己的水平**，

我们没有那么优秀，“我太愚蠢了，写不出好代码”。

<br/>

理解了这件事情之后，我们就明白了，

很多书中提到的 “优秀人士” 不是在说我们。

<br/>

假如有人说，“优秀的程序员应当尽量不写注释”，我们就得明白，

不写注释，只是对 “优秀的程序员” 来说的，不是在说我们，

我们代码写的本来就不好，还不写注释，那不是更难懂吗？

### 当心矫枉过正

其实很多建议，是针对某些**特定人群**来说的，

或者说是**督促**人们做好的一种未必有效的建议。

<br/>

孟子在 《尽心章句下》中写道，

> 尽信书，则不如无书。

<br/>

这句话是针对于 “尽信书者” 而言的，

如果本来就有怀疑精神了，再因为这句话变得 “事事怀疑”，那就矫枉过正了。

也就是说，只要能避免 “尽信书”，就已经达到劝诫的目的了。

<br/>

类似的，在 《[高效能程序员的修炼](https://book.douban.com/subject/24868904/)》 中，作者说，

> 避免写注释，你应该总是专注于编写代码，而忘了还有注释这种东西的存在。

<br/>

这是一种建议，通过这样的练习，**有可能**会让我们的代码写的更清晰，

也有可能练不成。

<br/>

这句话是针对于那些，过于依赖注释这根 “拐杖” 的人说的。

如果能不写注释，就坚决不写注释，那也是矫枉过正了。

### 信息丢失

由于计算机只需要 “功能该如何执行” 这部分信息，

所以，代码中必备的信息量是很少的，有很大一部分信息并没有保存到代码中。

<br/>

这样的代码在维护起来，就会遇到麻烦。

常见的信息丢失，有以下两种：编码动机的丢失，以及功能用法的遗漏。

#### （1）动机

Martin Fowler 说，

> Any fool can write code that a computer can understand.

> Good programmers write code that **humans can understand**.

<br/>

机器只要知道怎样执行就行了，

人还要知道**代码为什么要这样写**。

所以，对于 “为什么” 这样的信息，代码很难表述清楚的。

<br/>

这就像下棋一样，棋谱无法写出双方的用意。

<br/>

所以，代码和文档是不可分的，

它们将程序开发时的**环境信息**，尽可能多的保存了下来。

<br/>

“功能迁移” 为什么困难，

是因为当时的环境信息已经丢失了，

当时所有人都都认为是再正常不过的事情，现在已**无从得知**了。

<br/>

比如，我在进行迁移时，发现代码中有一份白名单，

白名单内硬编码了几个名字。代码写的确实很清晰，一看就知道这是一个白名单，

但为什么需要这个名单？名单中为什么是这些名字？

<br/>

可能只有当时写代码的人才知道了吧。

#### （2）用法

不知道你有没有遇到过这样的场景，当我们咨询其他人某个功能怎么用的时候，

他让我们去读源码，**推断**出功能的使用方式。

<br/>

这其实是一种很不好的编码风格，

他丢失了 “功能该如何被使用” 这个非常重要的信息。

使得很多缺陷都出在**系统的边界**上，大大增加了集成测试的难度和成本。

<br/>

所以，一个完整的功能，应至少包括两个部分：

（1）使用说明

（2）具体实现

<br/>

使用说明无法写到代码中，因为执行代码的机器不管这些。

它只管按照代码描述的方式运行。

<br/>

所以，这一部分的信息丢失，就不得不通过注释或者文档的方式来写下来。

不然就只有功能的实现者知道如何使用它了。

### 结语

对于注释而言，我觉得应该正反兼顾，

（1）代码能交代清楚的，没必要写到注释中

（2）代码不能交代清楚的，别忘了记下来

<br/>

任何时候，别人问 “为什么不写注释” 的时候，

最好别答 “代码即文档”，

不能把赞扬别人的托词，用在自己身上。

<br/>

反之，我们应该把头低下来，耐心的倾听他人的建议，

这样才能把代码写的越来越好，

从糟糕的程序员，变成一般的程序员吧。
